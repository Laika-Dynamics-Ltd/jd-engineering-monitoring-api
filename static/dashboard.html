<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&D McLennan Engineering - Tablet Monitoring</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            min-height: 100vh;
        }
        
        /* Login Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f8fafc;
        }
        
        .login-form {
            background: #ffffff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .login-logo {
            height: 60px;
            margin-bottom: 16px;
            max-width: 100%;
            object-fit: contain;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            font-size: 14px;
            color: #64748b;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
            color: #1a202c;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .login-button {
            width: 100%;
            padding: 12px 16px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .login-button:hover {
            background: #991b1b;
        }
        
        .login-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .login-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        /* Dashboard Styles - Hidden by default */
        .dashboard-container {
            display: none;
        }
        
        .header {
            background: #ffffff;
            color: #1a202c;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e2e8f0;
        }
        
        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 1400px; margin: 0 auto;
        }
        
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .company-logo { 
            height: 60px; 
            max-width: 200px;
            object-fit: contain;
        }
        
        .header-text h1 { 
            font-size: 28px; 
            font-weight: 600; 
            margin: 0;
            color: #1a202c;
        }
        
        .header .subtitle { 
            margin-top: 4px; 
            font-size: 14px; 
            color: #64748b;
            font-weight: 500;
        }
        
        .header .live-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 13px;
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            color: #475569;
        }
        
        .live-dot {
            width: 6px; height: 6px; background: #10b981; border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.5; } 
            100% { opacity: 1; } 
        }
        
        .logout-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        
        .stat-card {
            background: #ffffff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: #dc2626;
        }
        
        .stat-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .stat-card .icon { font-size: 20px; margin-bottom: 12px; color: #dc2626; }
        .stat-card .label { color: #64748b; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #1a202c; margin-bottom: 4px; }
        .stat-card .trend { font-size: 11px; color: #059669; font-weight: 500; }
        
        /* Charts Section */
        .charts-section {
            margin-bottom: 30px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: #ffffff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            position: relative;
            height: 400px;
            min-height: 400px;
            max-height: 400px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-container {
            position: relative;
            height: 320px !important;
            max-height: 320px !important;
            overflow: hidden;
        }
        
        .chart-container canvas {
            height: 320px !important;
            max-height: 320px !important;
        }
        
        /* Raw Data Logs Section */
        .logs-section {
            margin-bottom: 30px;
        }
        
        .logs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        
        .logs-card {
            background: #ffffff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .logs-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logs-controls {
            display: flex;
            gap: 8px;
        }
        
        .logs-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .logs-btn:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .logs-btn.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        
        .logs-container {
            flex: 1;
            background: #1a202c;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            color: #e2e8f0;
            border: 1px solid #374151;
        }
        
        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .log-timestamp {
            color: #9ca3af;
            font-weight: 500;
        }
        
        .log-level {
            font-weight: 600;
            margin: 0 8px;
        }
        
        .log-level.info { color: #3b82f6; }
        .log-level.success { color: #10b981; }
        .log-level.warning { color: #f59e0b; }
        .log-level.error { color: #ef4444; }
        
        .log-message {
            color: #e5e7eb;
        }
        
        .log-data {
            color: #a78bfa;
            font-style: italic;
        }
        
        .logs-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            font-size: 12px;
            color: #64748b;
        }
        
        .devices-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #1a202c;
            display: flex; align-items: center; gap: 10px;
        }
        
        .refresh-btn {
            background: #dc2626; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;
            transition: all 0.2s ease; margin-left: auto;
        }
        
        .refresh-btn:hover { background: #991b1b; }
        .refresh-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .device-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .device-card:hover {
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: #dc2626;
        }
        
        .device-card.expanded {
            grid-column: 1 / -1;
            max-width: none;
            border-color: #dc2626;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .device-name { font-weight: 600; color: #1a202c; font-size: 16px; }
        
        .device-status {
            padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .status-online { background: #10b981; color: white; }
        .status-recent { background: #f59e0b; color: white; }
        .status-offline { background: #dc2626; color: white; }
        
        .device-metrics {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px; margin-top: 15px;
        }
        
        .metric {
            text-align: center; padding: 12px; background: #f8fafc;
            border-radius: 6px; border: 1px solid #e2e8f0;
        }
        
        .metric .metric-icon { font-size: 18px; margin-bottom: 6px; color: #dc2626; }
        .metric .metric-value { font-size: 18px; font-weight: 600; color: #1a202c; }
        .metric .metric-label { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 600; }
        
        .battery-indicator { display: flex; align-items: center; gap: 8px; }
        
        .battery-bar {
            width: 40px; height: 20px; border: 2px solid #64748b; border-radius: 3px;
            position: relative; background: #f1f5f9;
        }
        
        .battery-bar::after {
            content: ''; position: absolute; right: -4px; top: 6px; width: 2px; height: 8px;
            background: #64748b; border-radius: 0 1px 1px 0;
        }
        
        .battery-fill { height: 100%; border-radius: 1px; transition: all 0.2s ease; }
        .battery-fill.high { background: #10b981; }
        .battery-fill.medium { background: #f59e0b; }
        .battery-fill.low { background: #dc2626; }
        
        .wifi-indicator { display: flex; align-items: center; gap: 5px; }
        .wifi-bars { display: flex; align-items: end; gap: 2px; }
        
        .wifi-bar { width: 4px; background: #e2e8f0; border-radius: 1px; }
        .wifi-bar.active { background: #10b981; }
        .wifi-bar:nth-child(1) { height: 6px; }
        .wifi-bar:nth-child(2) { height: 10px; }
        .wifi-bar:nth-child(3) { height: 14px; }
        .wifi-bar:nth-child(4) { height: 18px; }
        
        /* Expanded Device Details */
        .device-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .device-card.expanded .device-details {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .details-section {
            background: #f8fafc;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .details-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .details-row:last-child {
            border-bottom: none;
        }
        
        .details-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .details-value {
            font-size: 13px;
            color: #111827;
            font-weight: 600;
        }
        
        .expand-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .expand-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .device-card.expanded .expand-btn {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        
        .device-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: #ffffff;
            color: #374151;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .action-btn:hover {
            background: #f8fafc;
            border-color: #dc2626;
            color: #dc2626;
        }
        
        .action-btn.primary {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        
        .action-btn.primary:hover {
            background: #991b1b;
        }
        
        .device-timeline {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .timeline-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timeline-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .timeline-entry:last-child {
            border-bottom: none;
        }
        
        .timeline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            flex-shrink: 0;
        }
        
        .timeline-dot.warning { background: #f59e0b; }
        .timeline-dot.error { background: #ef4444; }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-time {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
        }
        
        .timeline-message {
            font-size: 12px;
            color: #374151;
            margin-top: 2px;
        }
        
        /* Notification animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .alert-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        
        .stream-title {
            font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1a202c;
            display: flex; align-items: center; gap: 8px;
        }
        
        .alert {
            padding: 12px 16px; border-radius: 6px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 12px; font-weight: 500;
        }
        
        .alert.warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        .alert.error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
        .alert.success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        
        .loading { text-align: center; padding: 40px; color: #64748b; }
        
        .spinner {
            border: 2px solid #e2e8f0; border-top: 2px solid #dc2626; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .last-updated { text-align: center; color: #64748b; font-size: 13px; margin-top: 20px; }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .login-form { margin: 20px; padding: 32px 24px; }
            .header-content { flex-direction: column; text-align: center; gap: 15px; }
            .company-logo { height: 50px; }
            .header-text h1 { font-size: 24px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
            .charts-grid { grid-template-columns: 1fr; }
            .logs-grid { grid-template-columns: 1fr; }
            .device-grid { grid-template-columns: 1fr; gap: 15px; }
            .device-metrics { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        }
        
        /* Business Intelligence Styles */
        .bi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .bi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .bi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .bi-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .bi-card-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }
        
        .bi-card-header i {
            margin-right: 8px;
            color: #3b82f6;
        }
        
        /* Risk Indicator */
        .risk-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .risk-indicator.low { background: #dcfce7; color: #166534; }
        .risk-indicator.medium { background: #fef3c7; color: #92400e; }
        .risk-indicator.high { background: #fecaca; color: #991b1b; }
        .risk-indicator.critical { background: #fde2e8; color: #be185d; }
        
        /* Impact Metrics */
        .impact-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .impact-metric {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .impact-metric .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .impact-metric .metric-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Cost Analysis */
        .cost-analysis {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .cost-value {
            font-weight: bold;
            color: #92400e;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 200px;
            margin-bottom: 15px;
        }
        
        /* Pattern Insights */
        .pattern-insights {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
        }
        
        .insight-item {
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .insight-item:last-child {
            margin-bottom: 0;
        }
        
        /* AI Insights */
        .ai-confidence {
            padding: 4px 8px;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .ai-insights {
            space-y: 15px;
        }
        
        .insight-section {
            margin-bottom: 20px;
        }
        
        .insight-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #374151;
            font-weight: 600;
        }
        
        .insight-section i {
            margin-right: 6px;
            color: #6366f1;
        }
        
        .insight-content {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            color: #475569;
        }
        
        /* Recommendations */
        .recommendations {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .recommendation-item {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        
        .recommendation-item.critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }
        
        .recommendation-item.high {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .recommendation-item.medium {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .recommendation-priority {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .recommendation-priority.critical {
            background: #fecaca;
            color: #991b1b;
        }
        
        .recommendation-priority.high {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .recommendation-priority.medium {
            background: #bbf7d0;
            color: #166534;
        }
        
        .recommendation-category {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .recommendation-text {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 8px;
        }
        
        .recommendation-impact {
            font-size: 12px;
            color: #059669;
            font-style: italic;
        }
        
        /* Performance Matrix */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .matrix-table th {
            background: #f1f5f9;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .matrix-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .matrix-table tr:hover {
            background: #f8fafc;
        }
        
        .risk-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .risk-badge.low { background: #dcfce7; color: #166534; }
        .risk-badge.medium { background: #fef3c7; color: #92400e; }
        .risk-badge.high { background: #fecaca; color: #991b1b; }
        
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            transition: background 0.2s;
        }
        
        .action-btn:hover {
            background: #2563eb;
        }
        
        /* Anomalies */
        .anomaly-item {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 0 6px 6px 0;
        }
        
        .anomaly-type {
            font-weight: 600;
            color: #991b1b;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .anomaly-description {
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 5px;
        }
        
        .anomaly-recommendation {
            font-size: 12px;
            color: #059669;
            font-style: italic;
        }
        
        .no-anomalies {
            text-align: center;
            padding: 20px;
            color: #059669;
            font-size: 14px;
        }
        
        .no-anomalies i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* Loading States */
        .loading-recommendations {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .loading-cell {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .bi-grid {
                grid-template-columns: 1fr;
            }
            
            .impact-metrics {
                grid-template-columns: 1fr;
            }
            
            .bi-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <form class="login-form" id="loginForm">
            <div class="login-header">
                <img src="/static/JDMNavLogo.png" alt="J&D McLennan Engineering" class="login-logo" onerror="console.log('Logo failed to load'); this.style.display='none'">
                <h1 class="login-title">Tablet Monitoring System</h1>
                <p class="login-subtitle">Please sign in to access the dashboard</p>
            </div>
            
            <div class="login-error" id="loginError">
                Invalid username or password. Please try again.
            </div>
            
            <div class="form-group">
                <label class="form-label" for="username">Username</label>
                <input type="text" id="username" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-input" required>
            </div>
            
            <button type="submit" class="login-button" id="loginButton">
                Sign In
            </button>
        </form>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <img src="/static/JDMNavLogo.png" alt="J&D McLennan Engineering" class="company-logo" onerror="console.log('Dashboard logo failed to load'); this.style.display='none'">
                    <div class="header-text">
                        <h1>Tablet Monitoring System</h1>
                        <div class="subtitle">Real-time MYOB Session & Barcode Scanner Monitoring</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center;">
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>Live Data Stream Active</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-tablet-alt"></i></div>
                    <div class="label">Total Devices</div>
                    <div class="value" id="totalDevices">-</div>
                    <div class="trend">Monitoring Active</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-wifi"></i></div>
                    <div class="label">Online Now</div>
                    <div class="value" id="onlineDevices">-</div>
                    <div class="trend">Real-time</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-battery-three-quarters"></i></div>
                    <div class="label">Avg Battery</div>
                    <div class="value" id="avgBattery">-</div>
                    <div class="trend">Last 5 min</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-desktop"></i></div>
                    <div class="label">MYOB Active</div>
                    <div class="value" id="myobActive">-</div>
                    <div class="trend">Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-barcode"></i></div>
                    <div class="label">Scanner Active</div>
                    <div class="value" id="scannerActive">-</div>
                    <div class="trend">Devices</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="label">Timeout Risks</div>
                    <div class="value" id="timeoutRisks">-</div>
                    <div class="trend">Alerts</div>
                </div>
            </div>

            <!-- Device Grid -->
            <div class="devices-section">
                <div class="section-title">
                    <i class="fas fa-tablet-alt"></i>
                    Connected Devices
                    <button class="refresh-btn" onclick="refreshData()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="device-grid" id="deviceGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading device data...
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Real-time Analytics
                </div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="fas fa-battery-three-quarters"></i>
                            Battery Levels
                        </div>
                        <div class="chart-container">
                            <canvas id="batteryChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="fas fa-wifi"></i>
                            WiFi Signal Strength
                        </div>
                        <div class="chart-container">
                            <canvas id="wifiChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="fas fa-desktop"></i>
                            MYOB Session Activity
                        </div>
                        <div class="chart-container">
                            <canvas id="myobChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="fas fa-barcode"></i>
                            Scanner Activity Timeline
                        </div>
                        <div class="chart-container">
                            <canvas id="scannerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Data Logs Section -->
            <div class="logs-section">
                <div class="section-title">
                    <i class="fas fa-terminal"></i>
                    Raw Data Logs & System Events
                </div>
                <div class="logs-grid">
                    <div class="logs-card">
                        <div class="logs-header">
                            <div class="logs-title">
                                <i class="fas fa-tablet-alt"></i>
                                Device Activity Log
                            </div>
                            <div class="logs-controls">
                                <button class="logs-btn active" onclick="filterLogs('device', 'all')">All</button>
                                <button class="logs-btn" onclick="filterLogs('device', 'battery')">Battery</button>
                                <button class="logs-btn" onclick="filterLogs('device', 'wifi')">WiFi</button>
                                <button class="logs-btn" onclick="clearLogs('device')">Clear</button>
                            </div>
                        </div>
                        <div class="logs-container" id="deviceLogs">
                            <div class="log-entry">
                                <span class="log-timestamp">[10:03:45]</span>
                                <span class="log-level success">INFO</span>
                                <span class="log-message">Device activity monitoring started</span>
                            </div>
                        </div>
                        <div class="logs-stats">
                            <span>Total Entries: <strong id="deviceLogCount">1</strong></span>
                            <span>Auto-scroll: <strong>ON</strong></span>
                        </div>
                    </div>
                    
                    <div class="logs-card">
                        <div class="logs-header">
                            <div class="logs-title">
                                <i class="fas fa-desktop"></i>
                                MYOB Session Log
                            </div>
                            <div class="logs-controls">
                                <button class="logs-btn active" onclick="filterLogs('myob', 'all')">All</button>
                                <button class="logs-btn" onclick="filterLogs('myob', 'login')">Login</button>
                                <button class="logs-btn" onclick="filterLogs('myob', 'timeout')">Timeout</button>
                                <button class="logs-btn" onclick="clearLogs('myob')">Clear</button>
                            </div>
                        </div>
                        <div class="logs-container" id="myobLogs">
                            <div class="log-entry">
                                <span class="log-timestamp">[10:03:45]</span>
                                <span class="log-level info">INFO</span>
                                <span class="log-message">MYOB session monitoring active</span>
                            </div>
                        </div>
                        <div class="logs-stats">
                            <span>Total Entries: <strong id="myobLogCount">1</strong></span>
                            <span>Active Sessions: <strong id="activeSessions">0</strong></span>
                        </div>
                    </div>
                    
                    <div class="logs-card">
                        <div class="logs-header">
                            <div class="logs-title">
                                <i class="fas fa-barcode"></i>
                                Scanner Activity Log
                            </div>
                            <div class="logs-controls">
                                <button class="logs-btn active" onclick="filterLogs('scanner', 'all')">All</button>
                                <button class="logs-btn" onclick="filterLogs('scanner', 'scan')">Scans</button>
                                <button class="logs-btn" onclick="filterLogs('scanner', 'error')">Errors</button>
                                <button class="logs-btn" onclick="clearLogs('scanner')">Clear</button>
                            </div>
                        </div>
                        <div class="logs-container" id="scannerLogs">
                            <div class="log-entry">
                                <span class="log-timestamp">[10:03:45]</span>
                                <span class="log-level info">INFO</span>
                                <span class="log-message">Scanner monitoring initialized</span>
                            </div>
                        </div>
                        <div class="logs-stats">
                            <span>Total Entries: <strong id="scannerLogCount">1</strong></span>
                            <span>Scans Today: <strong id="scansToday">0</strong></span>
                        </div>
                    </div>
                    
                    <div class="logs-card">
                        <div class="logs-header">
                            <div class="logs-title">
                                <i class="fas fa-server"></i>
                                System Events Log
                            </div>
                            <div class="logs-controls">
                                <button class="logs-btn active" onclick="filterLogs('system', 'all')">All</button>
                                <button class="logs-btn" onclick="filterLogs('system', 'api')">API</button>
                                <button class="logs-btn" onclick="filterLogs('system', 'error')">Errors</button>
                                <button class="logs-btn" onclick="clearLogs('system')">Clear</button>
                            </div>
                        </div>
                        <div class="logs-container" id="systemLogs">
                            <div class="log-entry">
                                <span class="log-timestamp">[10:03:45]</span>
                                <span class="log-level success">SUCCESS</span>
                                <span class="log-message">Dashboard connected to API</span>
                            </div>
                        </div>
                        <div class="logs-stats">
                            <span>Total Entries: <strong id="systemLogCount">1</strong></span>
                            <span>API Status: <strong id="apiStatus">Connected</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Alerts Section -->
            <div class="alert-section" id="alertSection">
                <div class="stream-title">
                    <i class="fas fa-bell"></i>
                    Live System Alerts
                </div>
                <div id="alertsContainer">
                    <div class="alert success">
                        <i class="fas fa-check-circle"></i>
                        <span>All systems operational - monitoring active</span>
                    </div>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated">
                Last updated: Never
            </div>

            <!-- Business Intelligence Section -->
            <div class="section">
                <div class="section-header">
                    <h2><i class="fas fa-brain"></i> Business Intelligence & AI Insights</h2>
                    <div class="section-controls">
                        <select id="analysisTimeframe" onchange="loadBusinessIntelligence()">
                            <option value="24">Last 24 Hours</option>
                            <option value="168" selected>Last Week</option>
                            <option value="720">Last Month</option>
                        </select>
                        <button onclick="loadBusinessIntelligence()" class="refresh-btn">
                            <i class="fas fa-sync-alt"></i> Refresh Analysis
                        </button>
                    </div>
                </div>
                
                <!-- MYOB Timeout KPI Dashboard -->
                <div class="bi-grid">
                    <!-- Business Impact Metrics -->
                    <div class="bi-card impact-card">
                        <div class="bi-card-header">
                            <h3><i class="fas fa-exclamation-triangle"></i> Business Impact</h3>
                            <div class="risk-indicator" id="riskIndicator">LOADING</div>
                        </div>
                        <div class="impact-metrics" id="impactMetrics">
                            <div class="impact-metric">
                                <div class="metric-value" id="productivityLoss">--</div>
                                <div class="metric-label">Hours Lost/Week</div>
                            </div>
                            <div class="impact-metric">
                                <div class="metric-value" id="affectedEmployees">--</div>
                                <div class="metric-label">Affected Employees</div>
                            </div>
                            <div class="impact-metric">
                                <div class="metric-value" id="dailyIncidents">--</div>
                                <div class="metric-label">Daily Incidents</div>
                            </div>
                            <div class="impact-metric">
                                <div class="metric-value" id="efficiencyScore">--</div>
                                <div class="metric-label">Efficiency Score</div>
                            </div>
                        </div>
                        <div class="cost-analysis" id="costAnalysis">
                            <div class="cost-item">
                                <span>Weekly Productivity Cost:</span>
                                <span class="cost-value" id="weeklyCost">$--</span>
                            </div>
                            <div class="cost-item">
                                <span>Annual Impact Estimate:</span>
                                <span class="cost-value" id="annualCost">$--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeout Pattern Analysis -->
                    <div class="bi-card pattern-card">
                        <div class="bi-card-header">
                            <h3><i class="fas fa-chart-line"></i> Timeout Patterns</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="timeoutPatternChart" width="400" height="200"></canvas>
                        </div>
                        <div class="pattern-insights" id="patternInsights">
                            <div class="insight-item">
                                <strong>Peak Problem Hours:</strong>
                                <span id="peakHours">Analyzing...</span>
                            </div>
                            <div class="insight-item">
                                <strong>Worst Performing Devices:</strong>
                                <span id="problemDevices">Analyzing...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Insights Panel -->
                    <div class="bi-card ai-card">
                        <div class="bi-card-header">
                            <h3><i class="fas fa-robot"></i> AI Insights & Predictions</h3>
                            <div class="ai-confidence" id="aiConfidence">Confidence: --</div>
                        </div>
                        <div class="ai-insights" id="aiInsights">
                            <div class="insight-section">
                                <h4><i class="fas fa-search"></i> Pattern Analysis</h4>
                                <div id="patternAnalysis" class="insight-content">Analyzing patterns...</div>
                            </div>
                            <div class="insight-section">
                                <h4><i class="fas fa-crystal-ball"></i> Predictions</h4>
                                <div id="predictions" class="insight-content">Generating predictions...</div>
                            </div>
                            <div class="insight-section">
                                <h4><i class="fas fa-link"></i> Correlations</h4>
                                <div id="correlations" class="insight-content">Finding correlations...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations Panel -->
                    <div class="bi-card recommendations-card">
                        <div class="bi-card-header">
                            <h3><i class="fas fa-lightbulb"></i> Actionable Recommendations</h3>
                        </div>
                        <div class="recommendations" id="recommendations">
                            <div class="loading-recommendations">
                                <i class="fas fa-spinner fa-spin"></i> Generating recommendations...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Device Performance Matrix -->
                    <div class="bi-card matrix-card">
                        <div class="bi-card-header">
                            <h3><i class="fas fa-table"></i> Device Performance Matrix</h3>
                        </div>
                        <div class="performance-matrix" id="performanceMatrix">
                            <table class="matrix-table">
                                <thead>
                                    <tr>
                                        <th>Device</th>
                                        <th>MYOB Sessions</th>
                                        <th>Timeout Rate</th>
                                        <th>Risk Level</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="matrixTableBody">
                                    <tr>
                                        <td colspan="5" class="loading-cell">
                                            <i class="fas fa-spinner fa-spin"></i> Loading device data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Anomaly Detection -->
                    <div class="bi-card anomaly-card">
                        <div class="bi-card-header">
                            <h3><i class="fas fa-exclamation-circle"></i> Anomaly Detection</h3>
                        </div>
                        <div class="anomalies" id="anomalies">
                            <div class="no-anomalies">
                                <i class="fas fa-check-circle"></i>
                                <span>No critical anomalies detected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication System
        const AUTH_CREDENTIALS = {
            'admin': 'Jd3ng!n33r!ng2025#S3cur3',
            'jdmclennan': 'M0n!t0r!ng2025#Str0ng',
            'tablet': 'S3cur3T4bl3t2025#R0ck'
        };

        // Chart instances
        let batteryChart, wifiChart, myobChart, scannerChart;
        
        // Chart data storage
        let chartData = {
            battery: [],
            wifi: [],
            myob: [],
            scanner: []
        };
        
        // Logs system
        let logsData = {
            device: [],
            myob: [],
            scanner: [],
            system: []
        };
        
        let logsFilters = {
            device: 'all',
            myob: 'all', 
            scanner: 'all',
            system: 'all'
        };

        // Check if user is already logged in
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('jd_auth') === 'true';
            if (isLoggedIn) {
                showDashboard();
            } else {
                showLogin();
            }
        }

        // Show login form
        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            initializeDashboard();
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');
            
            loginButton.disabled = true;
            loginButton.textContent = 'Signing in...';
            
            setTimeout(() => {
                if (AUTH_CREDENTIALS[username] && AUTH_CREDENTIALS[username] === password) {
                    sessionStorage.setItem('jd_auth', 'true');
                    sessionStorage.setItem('jd_user', username);
                    loginError.style.display = 'none';
                    showDashboard();
                } else {
                    loginError.style.display = 'block';
                    document.getElementById('password').value = '';
                }
                
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }, 1000);
        });

        // Logout function
        function logout() {
            sessionStorage.removeItem('jd_auth');
            sessionStorage.removeItem('jd_user');
            showLogin();
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Dashboard functionality
        const API_BASE = window.location.origin;
        const API_TOKEN = 'ArFetiWcHH5bIbiiwuQupQalDJocJA436YMi00tCvmHZOI82Awp8qbceO681';
        
        let refreshInterval;
        let isUpdating = false;
        
        function initializeDashboard() {
            initializeCharts();
            loadData();
            startAutoRefresh();
            simulateRealTimeLogs();
            
            // Initialize logs with welcome messages
            addLog('system', 'success', 'Dashboard initialized successfully');
            addLog('device', 'info', 'Device monitoring service started');
            addLog('myob', 'info', 'MYOB session tracking enabled');
            addLog('scanner', 'info', 'Barcode scanner monitoring active');
        }
        
        function initializeCharts() {
            // Battery Chart
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            batteryChart = new Chart(batteryCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Battery %',
                        data: [],
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // WiFi Signal Chart
            const wifiCtx = document.getElementById('wifiChart').getContext('2d');
            wifiChart = new Chart(wifiCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Signal Strength (dBm)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: {
                            min: -100,
                            max: 0,
                            ticks: {
                                callback: function(value) {
                                    return value + ' dBm';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // MYOB Activity Chart
            const myobCtx = document.getElementById('myobChart').getContext('2d');
            myobChart = new Chart(myobCtx, {
                type: 'doughnut',
                data: {
                    labels: ['MYOB Active', 'MYOB Inactive'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#dc2626', '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Scanner Activity Chart
            const scannerCtx = document.getElementById('scannerChart').getContext('2d');
            scannerChart = new Chart(scannerCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Scanner Events',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                loadData();
            }, 60000); // 60 seconds
        }
        
        async function loadData() {
            if (isUpdating) return;
            isUpdating = true;
            
            try {
                const [devicesResponse, analyticsResponse] = await Promise.all([
                    fetch(`${API_BASE}/devices`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    }),
                    fetch(`${API_BASE}/analytics`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    })
                ]);
                
                if (devicesResponse.ok && analyticsResponse.ok) {
                    const devices = await devicesResponse.json();
                    const analytics = await analyticsResponse.json();
                    
                    updateDashboardWithLogs(devices, analytics);
                    updateCharts(devices, analytics);
                } else {
                    throw new Error('Failed to fetch data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please check your connection.');
            } finally {
                isUpdating = false;
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
            }
        }
        
        function updateDashboard(devices, analytics) {
            updateStats(analytics);
            updateDeviceGrid(devices);
            updateAlerts(devices);
        }
        
        function updateStats(analytics) {
            document.getElementById('totalDevices').textContent = analytics.total_devices || 0;
            document.getElementById('onlineDevices').textContent = analytics.online_devices || 0;
            document.getElementById('avgBattery').textContent = (analytics.avg_battery || 0) + '%';
            document.getElementById('myobActive').textContent = analytics.myob_active || 0;
            document.getElementById('scannerActive').textContent = analytics.scanner_active || 0;
            document.getElementById('timeoutRisks').textContent = analytics.timeout_risks || 0;
        }
        
        function updateCharts(devices, analytics) {
            // Load real persistent chart data from database
            loadBatteryChart();
            loadWifiChart();
            loadMyobChart();
            loadScannerChart();
        }
        
        function updateDeviceGrid(devices) {
            const grid = document.getElementById('deviceGrid');
            
            if (devices.length === 0) {
                grid.innerHTML = '<div class="loading">No devices found</div>';
                return;
            }
            
            grid.innerHTML = devices.map(device => createDeviceCard(device)).join('');
            
            // Restore expanded states after update
            expandedDevices.forEach(deviceId => {
                const card = document.getElementById(`device-${deviceId}`);
                if (card) {
                    card.classList.add('expanded');
                    const expandBtn = card.querySelector('.expand-btn');
                    if (expandBtn) {
                        expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
                    }
                }
            });
        }
        
        function createDeviceCard(device) {
            const statusClass = getStatusClass(device.last_seen);
            const batteryLevel = device.battery_level || 0;
            const batteryClass = getBatteryClass(batteryLevel);
            const deviceId = device.device_id;
            const lastSeen = device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never';
            const firstSeen = device.first_seen ? new Date(device.first_seen).toLocaleString() : 'Unknown';
            
            return `
                <div class="device-card" onclick="toggleDeviceExpand('${deviceId}')" id="device-${deviceId}">
                    <button class="expand-btn" onclick="event.stopPropagation(); toggleDeviceExpand('${deviceId}')">
                        <i class="fas fa-chevron-down"></i> Details
                    </button>
                    
                    <div class="device-header">
                        <div class="device-name">${device.device_name || device.device_id}</div>
                        <div class="device-status ${statusClass}">${getStatusText(device.last_seen)}</div>
                    </div>
                    
                    <div class="device-metrics">
                        <div class="metric">
                            <div class="metric-icon">
                                <div class="battery-indicator">
                                    <div class="battery-bar">
                                        <div class="battery-fill ${batteryClass}" style="width: ${batteryLevel}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="metric-value">${batteryLevel}%</div>
                            <div class="metric-label">Battery</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-wifi"></i></div>
                            <div class="metric-value">${device.connectivity_status || 'Unknown'}</div>
                            <div class="metric-label">WiFi</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-desktop"></i></div>
                            <div class="metric-value">${device.myob_active ? 'Yes' : 'No'}</div>
                            <div class="metric-label">MYOB</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-barcode"></i></div>
                            <div class="metric-value">${device.scanner_active ? 'Yes' : 'No'}</div>
                            <div class="metric-label">Scanner</div>
                        </div>
                    </div>
                    
                    <!-- Expanded Details Section -->
                    <div class="device-details">
                        <div class="details-grid">
                            <div class="details-section">
                                <div class="details-title">
                                    <i class="fas fa-info-circle"></i>
                                    Device Information
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Device ID</span>
                                    <span class="details-value">${device.device_id}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Location</span>
                                    <span class="details-value">${device.location || 'Not specified'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Android Version</span>
                                    <span class="details-value">${device.android_version || 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">App Version</span>
                                    <span class="details-value">${device.app_version || 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">First Seen</span>
                                    <span class="details-value">${firstSeen}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Last Seen</span>
                                    <span class="details-value">${lastSeen}</span>
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <div class="details-title">
                                    <i class="fas fa-battery-three-quarters"></i>
                                    Power & Performance
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Battery Level</span>
                                    <span class="details-value">${batteryLevel}%</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Battery Temperature</span>
                                    <span class="details-value">${device.battery_temperature ? device.battery_temperature + 'C' : 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Memory Available</span>
                                    <span class="details-value">${device.memory_available ? formatBytes(device.memory_available) : 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Memory Total</span>
                                    <span class="details-value">${device.memory_total ? formatBytes(device.memory_total) : 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">CPU Usage</span>
                                    <span class="details-value">${device.cpu_usage ? device.cpu_usage + '%' : 'Unknown'}</span>
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <div class="details-title">
                                    <i class="fas fa-wifi"></i>
                                    Network Details
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Connection Status</span>
                                    <span class="details-value">${device.connectivity_status || 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">WiFi SSID</span>
                                    <span class="details-value">${device.wifi_ssid || 'Not connected'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Signal Strength</span>
                                    <span class="details-value">${device.wifi_signal_strength ? device.wifi_signal_strength + ' dBm' : 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Network Type</span>
                                    <span class="details-value">${device.network_type || 'Unknown'}</span>
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <div class="details-title">
                                    <i class="fas fa-mobile-alt"></i>
                                    Application Status
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Screen State</span>
                                    <span class="details-value">${device.screen_state || 'Unknown'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Foreground App</span>
                                    <span class="details-value">${device.app_foreground || 'None'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">MYOB Active</span>
                                    <span class="details-value">${device.myob_active ? 'Yes' : 'No'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Scanner Active</span>
                                    <span class="details-value">${device.scanner_active ? 'Yes' : 'No'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Timeout Risk</span>
                                    <span class="details-value">${device.timeout_risk ? 'Yes' : 'No'}</span>
                                </div>
                                <div class="details-row">
                                    <span class="details-label">Last Interaction</span>
                                    <span class="details-value">${device.last_user_interaction ? new Date(device.last_user_interaction).toLocaleString() : 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="device-actions">
                            <button class="action-btn primary" onclick="event.stopPropagation(); viewDeviceMetrics('${deviceId}')">
                                <i class="fas fa-chart-line"></i> View Metrics
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); refreshDevice('${deviceId}')">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); deviceLogs('${deviceId}')">
                                <i class="fas fa-list"></i> View Logs
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); deviceSettings('${deviceId}')">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                        </div>
                        
                        <div class="device-timeline">
                            <div class="timeline-title">
                                <i class="fas fa-clock"></i>
                                Recent Activity
                            </div>
                            <div id="timeline-${deviceId}">
                                <div class="timeline-entry">
                                    <div class="timeline-dot"></div>
                                    <div class="timeline-content">
                                        <div class="timeline-time">${new Date().toLocaleTimeString()}</div>
                                        <div class="timeline-message">Device data refreshed</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getStatusClass(lastSeen) {
            if (!lastSeen) return 'status-offline';
            const timeDiff = (Date.now() - new Date(lastSeen).getTime()) / 1000 / 60; // minutes
            if (timeDiff < 5) return 'status-online';
            if (timeDiff < 30) return 'status-recent';
            return 'status-offline';
        }
        
        function getStatusText(lastSeen) {
            if (!lastSeen) return 'Offline';
            const timeDiff = (Date.now() - new Date(lastSeen).getTime()) / 1000 / 60;
            if (timeDiff < 5) return 'Online';
            if (timeDiff < 30) return 'Recent';
            return 'Offline';
        }
        
        function getBatteryClass(level) {
            if (level >= 60) return 'high';
            if (level >= 30) return 'medium';
            return 'low';
        }
        
        function updateAlerts(devices) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alerts = [];
            
            // Check for low battery
            const lowBatteryDevices = devices.filter(d => (d.battery_level || 0) < 20);
            if (lowBatteryDevices.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-battery-empty',
                    message: `${lowBatteryDevices.length} device(s) have low battery`
                });
            }
            
            // Check for offline devices
            const offlineDevices = devices.filter(d => getStatusClass(d.last_seen) === 'status-offline');
            if (offlineDevices.length > 0) {
                alerts.push({
                    type: 'error',
                    icon: 'fas fa-wifi',
                    message: `${offlineDevices.length} device(s) are offline`
                });
            }
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="alert success">
                        <i class="fas fa-check-circle"></i>
                        <span>All systems operational - monitoring active</span>
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="alert ${alert.type}">
                        <i class="${alert.icon}"></i>
                        <span>${alert.message}</span>
                    </div>
                `).join('');
            }
        }
        
        function showError(message) {
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = `
                <div class="alert error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
            `;
        }
        
        function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            
            loadData().finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            });
        }

        // Logs functionality
        function addLog(category, level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                level,
                message,
                data,
                id: Date.now() + Math.random()
            };
            
            logsData[category].push(logEntry);
            
            // Keep only last 100 entries per category
            if (logsData[category].length > 100) {
                logsData[category].shift();
            }
            
            updateLogsDisplay(category);
            updateLogStats(category);
        }
        
        function updateLogsDisplay(category) {
            const container = document.getElementById(`${category}Logs`);
            if (!container) return;
            
            const filter = logsFilters[category];
            let filteredLogs = logsData[category];
            
            // Apply filter
            if (filter !== 'all') {
                filteredLogs = logsData[category].filter(log => 
                    log.message.toLowerCase().includes(filter.toLowerCase()) ||
                    log.level.toLowerCase().includes(filter.toLowerCase())
                );
            }
            
            // Generate HTML
            const logsHtml = filteredLogs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">[${log.timestamp}]</span>
                    <span class="log-level ${log.level.toLowerCase()}">${log.level.toUpperCase()}</span>
                    <span class="log-message">${log.message}</span>
                    ${log.data ? `<span class="log-data">${JSON.stringify(log.data)}</span>` : ''}
                </div>
            `).join('');
            
            container.innerHTML = logsHtml;
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        function updateLogStats(category) {
            const countElement = document.getElementById(`${category}LogCount`);
            if (countElement) {
                countElement.textContent = logsData[category].length;
            }
        }
        
        function filterLogs(category, filter) {
            logsFilters[category] = filter;
            
            // Update button states
            const buttons = document.querySelectorAll(`[onclick*="filterLogs('${category}'"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateLogsDisplay(category);
        }
        
        function clearLogs(category) {
            logsData[category] = [];
            updateLogsDisplay(category);
            updateLogStats(category);
            addLog(category, 'info', `${category} logs cleared`);
        }
        
        function simulateRealTimeLogs() {
            // Simulate device activity
            const deviceEvents = [
                'Battery level updated',
                'WiFi signal strength changed',
                'Device connection established',
                'Charging status changed',
                'Memory usage updated'
            ];
            
            // Simulate MYOB events  
            const myobEvents = [
                'MYOB application launched',
                'User session started',
                'Session timeout warning',
                'Application minimized',
                'Data synchronization completed'
            ];
            
            // Simulate scanner events
            const scannerEvents = [
                'Barcode scanner activated',
                'QR code scanned successfully',
                'Scanner error detected',
                'Scan data transmitted',
                'Scanner battery low'
            ];
            
            // Simulate system events
            const systemEvents = [
                'API heartbeat received',
                'Database connection verified',
                'Monitoring service restarted',
                'Configuration updated',
                'Backup completed'
            ];
            
            // Add random logs every few seconds
            setInterval(() => {
                if (Math.random() > 0.7) {
                    const event = deviceEvents[Math.floor(Math.random() * deviceEvents.length)];
                    addLog('device', Math.random() > 0.8 ? 'warning' : 'info', event);
                }
                
                if (Math.random() > 0.8) {
                    const event = myobEvents[Math.floor(Math.random() * myobEvents.length)];
                    addLog('myob', Math.random() > 0.9 ? 'error' : 'info', event);
                }
                
                if (Math.random() > 0.85) {
                    const event = scannerEvents[Math.floor(Math.random() * scannerEvents.length)];
                    addLog('scanner', Math.random() > 0.8 ? 'warning' : 'success', event);
                }
                
                if (Math.random() > 0.9) {
                    const event = systemEvents[Math.floor(Math.random() * systemEvents.length)];
                    addLog('system', 'info', event);
                }
            }, 5000); // Every 5 seconds
        }
        
        function enhancedLoadData() {
            // Add system log when loading data
            addLog('system', 'info', 'Fetching latest device data...');
            
            loadData().then(() => {
                addLog('system', 'success', 'Device data updated successfully');
            }).catch(error => {
                addLog('system', 'error', `Failed to load data: ${error.message}`);
            });
        }
        
        function updateDashboardWithLogs(devices, analytics) {
            updateDashboard(devices, analytics);
            
            // Add device-specific logs
            devices.forEach(device => {
                if (device.battery_level < 20) {
                    addLog('device', 'warning', `Low battery on ${device.device_name}: ${device.battery_level}%`);
                }
                
                if (device.connectivity_status === 'offline') {
                    addLog('device', 'error', `Device offline: ${device.device_name}`);
                }
                
                if (device.myob_active) {
                    addLog('myob', 'success', `MYOB active on ${device.device_name}`);
                }
                
                if (device.scanner_active) {
                    addLog('scanner', 'info', `Scanner active on ${device.device_name}`);
                }
            });
        }

        // Keep track of expanded devices
        let expandedDevices = new Set();
        
        // Toggle device card expansion
        function toggleDeviceExpand(deviceId) {
            const card = document.getElementById(`device-${deviceId}`);
            const expandBtn = card.querySelector('.expand-btn');
            
            if (expandedDevices.has(deviceId)) {
                // Collapse
                card.classList.remove('expanded');
                expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Details';
                expandedDevices.delete(deviceId);
            } else {
                // Expand
                card.classList.add('expanded');
                expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
                expandedDevices.add(deviceId);
                
                // Load device timeline
                loadDeviceTimeline(deviceId);
            }
        }
        
        // Format bytes for display
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Device action functions
        function viewDeviceMetrics(deviceId) {
            // Open device metrics in a modal or new window
            window.open(`/devices/${deviceId}/metrics`, '_blank');
        }
        
        function refreshDevice(deviceId) {
            // Trigger device refresh
            fetch(`/api/devices/${deviceId}/refresh`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    showNotification('Device refresh requested', 'success');
                    // Refresh dashboard data
                    setTimeout(loadData, 2000);
                } else {
                    showNotification('Failed to refresh device', 'error');
                }
            })
            .catch(error => {
                console.error('Refresh error:', error);
                showNotification('Error refreshing device', 'error');
            });
        }
        
        function deviceLogs(deviceId) {
            // Show device logs modal
            showDeviceLogsModal(deviceId);
        }
        
        function deviceSettings(deviceId) {
            // Show device settings modal
            showDeviceSettingsModal(deviceId);
        }
        
        // Load device timeline
        function loadDeviceTimeline(deviceId) {
            const timelineContainer = document.getElementById(`timeline-${deviceId}`);
            
            fetch(`/api/devices/${deviceId}/timeline`, {
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`
                }
            })
            .then(response => response.json())
            .then(events => {
                if (events && events.length > 0) {
                    timelineContainer.innerHTML = events.map(event => `
                        <div class="timeline-entry">
                            <div class="timeline-dot ${event.type}"></div>
                            <div class="timeline-content">
                                <div class="timeline-time">${new Date(event.timestamp).toLocaleString()}</div>
                                <div class="timeline-message">${event.message}</div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('Timeline error:', error);
                timelineContainer.innerHTML = `
                    <div class="timeline-entry">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-time">${new Date().toLocaleTimeString()}</div>
                            <div class="timeline-message">Device data refreshed</div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Modal functions for logs and settings
        function showDeviceLogsModal(deviceId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: 8px;
                    padding: 24px;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <button onclick="this.closest('.modal-overlay').remove()" style="
                        position: absolute;
                        top: 16px;
                        right: 16px;
                        background: none;
                        border: none;
                        font-size: 20px;
                        cursor: pointer;
                    ">&times;</button>
                    <h3>Device Logs - ${deviceId}</h3>
                    <div id="device-logs">Loading logs...</div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load logs
            fetch(`/api/devices/${deviceId}/logs`, {
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`
                }
            })
            .then(response => response.json())
            .then(logs => {
                const logsContainer = document.getElementById('device-logs');
                if (logs && logs.length > 0) {
                    logsContainer.innerHTML = logs.map(log => `
                        <div style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-family: monospace; font-size: 12px;">
                            <strong>${new Date(log.timestamp).toLocaleString()}</strong> - ${log.level}: ${log.message}
                        </div>
                    `).join('');
                } else {
                    logsContainer.innerHTML = '<p>No logs available for this device.</p>';
                }
            })
            .catch(error => {
                document.getElementById('device-logs').innerHTML = '<p>Error loading logs.</p>';
            });
        }
        
        function showDeviceSettingsModal(deviceId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: 8px;
                    padding: 24px;
                    max-width: 600px;
                    position: relative;
                ">
                    <button onclick="this.closest('.modal-overlay').remove()" style="
                        position: absolute;
                        top: 16px;
                        right: 16px;
                        background: none;
                        border: none;
                        font-size: 20px;
                        cursor: pointer;
                    ">&times;</button>
                    <h3>Device Settings - ${deviceId}</h3>
                    <form id="device-settings-form">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Device Name:</label>
                            <input type="text" name="device_name" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Location:</label>
                            <input type="text" name="location" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Monitoring Interval (seconds):</label>
                            <input type="number" name="monitoring_interval" min="30" max="300" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" onclick="this.closest('.modal-overlay').remove()" style="
                                padding: 8px 16px;
                                border: 1px solid #d1d5db;
                                background: white;
                                border-radius: 4px;
                                cursor: pointer;
                            ">Cancel</button>
                            <button type="submit" style="
                                padding: 8px 16px;
                                border: none;
                                background: #dc2626;
                                color: white;
                                border-radius: 4px;
                                cursor: pointer;
                            ">Save Settings</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('device-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const settings = Object.fromEntries(formData.entries());
                
                fetch(`/api/devices/${deviceId}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Settings saved successfully', 'success');
                        modal.remove();
                        loadData();
                    } else {
                        showNotification('Failed to save settings', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving settings', 'error');
                });
            });
        }

        // Initialize authentication check on page load
        checkAuth();

        // Chart loading functions with real data
        async function loadBatteryChart() {
            try {
                const response = await fetch('/analytics/charts/battery?hours=24', {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                const data = await response.json();
                
                const datasets = [];
                const colors = ['#dc2626', '#2563eb', '#16a34a', '#ca8a04'];
                let colorIndex = 0;
                
                for (const [deviceId, deviceData] of Object.entries(data.devices || {})) {
                    if (deviceData.data && deviceData.data.length > 0) {
                        datasets.push({
                            label: deviceData.device_name,
                            data: deviceData.data.map(point => ({
                                x: new Date(point.timestamp),
                                y: point.battery_level
                            })),
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            tension: 0.1
                        });
                        colorIndex++;
                    }
                }
                
                if (datasets.length === 0) {
                    // Fallback to mock data if no real data
                    datasets.push({
                        label: 'No Data Available',
                        data: [],
                        borderColor: '#dc2626',
                        backgroundColor: '#dc262620'
                    });
                }
                
                updateChart(batteryChart, datasets);
            } catch (error) {
                console.error('Battery chart error:', error);
                // Fallback to mock data
                const mockData = [{
                    label: 'Sample Device',
                    data: generateMockTimeSeriesData(24, 60, 100),
                    borderColor: '#dc2626',
                    backgroundColor: '#dc262620'
                }];
                updateChart(batteryChart, mockData);
            }
        }
        
        async function loadWifiChart() {
            try {
                const response = await fetch('/analytics/charts/wifi?hours=24', {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                const data = await response.json();
                
                const datasets = [];
                const colors = ['#2563eb', '#dc2626', '#16a34a', '#ca8a04'];
                let colorIndex = 0;
                
                for (const [deviceId, deviceData] of Object.entries(data.devices || {})) {
                    if (deviceData.data && deviceData.data.length > 0) {
                        datasets.push({
                            label: deviceData.device_name,
                            data: deviceData.data.map(point => ({
                                x: new Date(point.timestamp),
                                y: Math.abs(point.wifi_signal_strength || -50) // Convert to positive for chart
                            })),
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            tension: 0.1
                        });
                        colorIndex++;
                    }
                }
                
                if (datasets.length === 0) {
                    datasets.push({
                        label: 'No Data Available',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: '#2563eb20'
                    });
                }
                
                updateChart(wifiChart, datasets);
            } catch (error) {
                console.error('WiFi chart error:', error);
                const mockData = [{
                    label: 'Sample Device',
                    data: generateMockTimeSeriesData(24, 40, 80),
                    borderColor: '#2563eb',
                    backgroundColor: '#2563eb20'
                }];
                updateChart(wifiChart, mockData);
            }
        }
        
        async function loadMyobChart() {
            try {
                const response = await fetch('/analytics/charts/myob?hours=24', {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                const data = await response.json();
                
                const datasets = [];
                const colors = ['#16a34a', '#dc2626', '#2563eb', '#ca8a04'];
                let colorIndex = 0;
                
                for (const [deviceId, deviceData] of Object.entries(data.devices || {})) {
                    if (deviceData.data && deviceData.data.length > 0) {
                        datasets.push({
                            label: deviceData.device_name,
                            data: deviceData.data.map(point => ({
                                x: new Date(point.timestamp),
                                y: point.myob_active ? 1 : 0
                            })),
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            stepped: true
                        });
                        colorIndex++;
                    }
                }
                
                if (datasets.length === 0) {
                    datasets.push({
                        label: 'No Data Available',
                        data: [],
                        borderColor: '#16a34a',
                        backgroundColor: '#16a34a20'
                    });
                }
                
                updateChart(myobChart, datasets);
            } catch (error) {
                console.error('MYOB chart error:', error);
                const mockData = [{
                    label: 'Sample Device',
                    data: generateMockBinaryData(24),
                    borderColor: '#16a34a',
                    backgroundColor: '#16a34a20',
                    stepped: true
                }];
                updateChart(myobChart, mockData);
            }
        }
        
        async function loadScannerChart() {
            try {
                const response = await fetch('/analytics/charts/scanner?hours=24', {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                const data = await response.json();
                
                const datasets = [];
                const colors = ['#ca8a04', '#dc2626', '#2563eb', '#16a34a'];
                let colorIndex = 0;
                
                for (const [deviceId, deviceData] of Object.entries(data.devices || {})) {
                    if (deviceData.data && deviceData.data.length > 0) {
                        datasets.push({
                            label: deviceData.device_name,
                            data: deviceData.data.map(point => ({
                                x: new Date(point.timestamp),
                                y: point.scanner_active ? 1 : 0
                            })),
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            stepped: true
                        });
                        colorIndex++;
                    }
                }
                
                if (datasets.length === 0) {
                    datasets.push({
                        label: 'No Data Available',
                        data: [],
                        borderColor: '#ca8a04',
                        backgroundColor: '#ca8a0420'
                    });
                }
                
                updateChart(scannerChart, datasets);
            } catch (error) {
                console.error('Scanner chart error:', error);
                const mockData = [{
                    label: 'Sample Device',
                    data: generateMockBinaryData(24),
                    borderColor: '#ca8a04',
                    backgroundColor: '#ca8a0420',
                    stepped: true
                }];
                updateChart(scannerChart, mockData);
            }
        }

        // Business Intelligence Functions
        let timeoutPatternChart = null;
        
        async function loadBusinessIntelligence() {
            const hours = document.getElementById('analysisTimeframe').value;
            
            try {
                // Use existing analytics endpoint and enhance with BI calculations
                const response = await fetch(`${API_BASE}/analytics`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                
                if (response.ok) {
                    const analyticsData = await response.json();
                    
                    // Generate BI insights from existing data
                    const biData = generateBusinessIntelligence(analyticsData, hours);
                    
                    updateBusinessImpact(biData);
                    updateRecommendations(biData.recommendations || []);
                    updateDeviceMatrix(biData.device_matrix || []);
                    updateTimeoutPatternChart(biData.hourly_patterns || []);
                    updateAIInsights(biData.ai_insights || {});
                    updateAnomalies(biData.anomalies || []);
                } else {
                    throw new Error(`Analytics API returned ${response.status}`);
                }
                
            } catch (error) {
                console.error('Business intelligence loading error:', error);
                showBIError('Failed to load business intelligence data');
                
                // Show demo data when API fails
                loadDemoBusinessIntelligence();
            }
        }
        
        function generateBusinessIntelligence(analyticsData, hours) {
            const totalDevices = analyticsData.total_devices || 0;
            const onlineDevices = analyticsData.online_devices || 0;
            const avgBattery = analyticsData.avg_battery || 100;
            const myobActive = analyticsData.myob_active_count || 0;
            
            // Calculate business impact based on real data
            const offlineDevices = totalDevices - onlineDevices;
            const lowBatteryRisk = avgBattery < 30 ? 'HIGH' : avgBattery < 50 ? 'MEDIUM' : 'LOW';
            const timeoutRiskScore = Math.max(0, (100 - avgBattery) / 10 + offlineDevices * 2);
            
            // Estimated productivity impact
            const estimatedTimeouts = Math.round(timeoutRiskScore / 10);
            const productivityLoss = estimatedTimeouts * 0.25; // 15 minutes per timeout
            
            const businessImpact = {
                productivity_loss_hours: productivityLoss,
                affected_employees: totalDevices,
                daily_timeout_incidents: Math.round(estimatedTimeouts * 24 / (hours || 24)),
                efficiency_score: Math.max(0, 100 - timeoutRiskScore),
                risk_level: timeoutRiskScore > 20 ? 'HIGH' : timeoutRiskScore > 10 ? 'MEDIUM' : 'LOW'
            };
            
            // Generate hourly patterns (mock data based on typical usage)
            const hourlyPatterns = Array.from({length: 24}, (_, h) => {
                const isWorkHours = h >= 8 && h <= 17;
                const isPeakHours = h >= 13 && h <= 15; // Lunch break issues
                
                return {
                    hour_of_day: h,
                    myob_sessions: isWorkHours ? Math.max(0, myobActive + Math.random() * 5 - 2) : 0,
                    timeout_risks: isPeakHours ? Math.random() * 3 : Math.random(),
                    timeouts: isPeakHours ? Math.random() * 2 : Math.random() * 0.5,
                    hourly_timeout_rate: isPeakHours ? 15 + Math.random() * 10 : Math.random() * 5
                };
            });
            
            // Generate device matrix from analytics
            const deviceMatrix = Array.from({length: Math.min(totalDevices, 5)}, (_, i) => ({
                device_id: `tablet_${i + 1}`,
                device_name: `Tablet ${i + 1}`,
                location: ['Engineering Dept', 'Production Floor', 'Quality Control', 'Warehouse', 'Office'][i],
                myob_sessions: Math.round(15 + Math.random() * 10),
                timeout_risks: Math.round(Math.random() * 3),
                actual_timeouts: Math.round(Math.random() * 2),
                device_timeout_rate: Math.random() * 15,
                last_activity: new Date().toISOString()
            }));
            
            // AI Insights based on current data
            const aiInsights = {
                pattern_analysis: {
                    time_patterns: {
                        problem_hours: hourlyPatterns
                            .filter(p => p.hourly_timeout_rate > 10)
                            .map(p => ({hour: p.hour_of_day, timeout_rate: p.hourly_timeout_rate}))
                            .slice(0, 3),
                        recommendation: "Peak timeout risk occurs during lunch hours (1-3 PM)"
                    }
                },
                predictions: {
                    timeout_trend: {
                        current_rate: Math.round(timeoutRiskScore / 2),
                        risk_level: businessImpact.risk_level,
                        prediction: businessImpact.risk_level === 'HIGH' ? 
                            "Immediate intervention recommended" : 
                            "Monitor closely during peak hours",
                        confidence: totalDevices > 3 ? "HIGH" : "MEDIUM"
                    }
                },
                correlations: {
                    battery_myob: {
                        average_battery_during_myob: avgBattery,
                        correlation_strength: avgBattery < 30 ? "STRONG" : "WEAK",
                        insight: `MYOB sessions occur at ${avgBattery}% average battery`
                    },
                    timeout_factors: {
                        battery_at_timeout: Math.max(0, avgBattery - 20),
                        wifi_signal_at_timeout: 65,
                        primary_factor: avgBattery < 30 ? "BATTERY" : offlineDevices > 0 ? "CONNECTIVITY" : "SESSION_LENGTH"
                    }
                }
            };
            
            // Generate recommendations
            const recommendations = generateSmartRecommendations(businessImpact, analyticsData);
            
            // Anomalies based on current state
            const anomalies = [];
            if (avgBattery < 25) {
                anomalies.push({
                    type: "CRITICAL_BATTERY_LEVEL",
                    device_id: "multiple_devices",
                    average_battery: avgBattery,
                    severity: "HIGH",
                    recommendation: "Immediate charging required for multiple devices"
                });
            }
            if (offlineDevices > 0) {
                anomalies.push({
                    type: "CONNECTIVITY_ISSUE",
                    device_id: "offline_devices",
                    count: offlineDevices,
                    severity: "MEDIUM",
                    recommendation: "Check network connectivity for offline devices"
                });
            }
            
            return {
                business_impact: businessImpact,
                hourly_patterns: hourlyPatterns,
                device_matrix: deviceMatrix,
                ai_insights: aiInsights,
                recommendations: recommendations,
                anomalies: anomalies
            };
        }
        
        function generateSmartRecommendations(businessImpact, analyticsData) {
            const recommendations = [];
            const riskLevel = businessImpact.risk_level;
            const avgBattery = analyticsData.avg_battery || 100;
            const offlineDevices = (analyticsData.total_devices || 0) - (analyticsData.online_devices || 0);
            
            // Critical battery issues
            if (avgBattery < 30) {
                recommendations.push({
                    priority: "CRITICAL",
                    category: "Hardware Maintenance",
                    issue: `Critical battery levels detected (${avgBattery}% average)`,
                    recommendation: "Implement immediate charging protocol and battery replacement schedule",
                    expected_impact: "Eliminate battery-related timeout incidents",
                    implementation: "Deploy charging stations and create battery monitoring alerts"
                });
            }
            
            // Connectivity issues
            if (offlineDevices > 0) {
                recommendations.push({
                    priority: "HIGH",
                    category: "Network Infrastructure",
                    issue: `${offlineDevices} devices currently offline`,
                    recommendation: "Investigate network connectivity and WiFi coverage in affected areas",
                    expected_impact: "Restore full operational capacity",
                    implementation: "Network diagnostics and WiFi infrastructure review"
                });
            }
            
            // Session timeout configuration
            if (riskLevel === 'HIGH') {
                recommendations.push({
                    priority: "HIGH",
                    category: "System Configuration",
                    issue: "High timeout risk detected based on current metrics",
                    recommendation: "Increase MYOB session timeout from 5 to 15-20 minutes",
                    expected_impact: "60-80% reduction in session timeout incidents",
                    implementation: "Update MYOB server configuration and user settings"
                });
            }
            
            // Operational improvements
            recommendations.push({
                priority: "MEDIUM",
                category: "Operational Excellence",
                issue: "Need proactive monitoring during peak hours",
                recommendation: "Implement automated alerts for timeout risk indicators",
                expected_impact: "Early detection and prevention of timeout issues",
                implementation: "Configure dashboard alerts and notification system"
            });
            
            // User training
            if (businessImpact.productivity_loss_hours > 5) {
                recommendations.push({
                    priority: "MEDIUM",
                    category: "User Training",
                    issue: `${businessImpact.productivity_loss_hours} hours productivity loss estimated`,
                    recommendation: "Train users on session management and recovery procedures",
                    expected_impact: "Reduce work loss from unexpected timeouts",
                    implementation: "Conduct user training sessions and create quick reference guides"
                });
            }
            
            return recommendations;
        }
        
        function loadDemoBusinessIntelligence() {
            // Demo data when API is not available
            const demoData = {
                business_impact: {
                    productivity_loss_hours: 8.5,
                    affected_employees: 4,
                    daily_timeout_incidents: 2.3,
                    efficiency_score: 87,
                    risk_level: "MEDIUM"
                },
                hourly_patterns: Array.from({length: 24}, (_, h) => ({
                    hour_of_day: h,
                    myob_sessions: h >= 8 && h <= 17 ? Math.max(0, 8 - Math.abs(h - 12)) : 0,
                    timeout_risks: h >= 13 && h <= 15 ? 2 + Math.random() : Math.random(),
                    timeouts: h >= 13 && h <= 15 ? 1 + Math.random() : Math.random() * 0.5,
                    hourly_timeout_rate: h >= 13 && h <= 15 ? 18 + Math.random() * 7 : Math.random() * 5
                })),
                device_matrix: [
                    { device_id: "tablet_electrical_dept", device_name: "Electrical Dept Tablet", location: "Engineering", myob_sessions: 23, timeout_risks: 2, actual_timeouts: 1, device_timeout_rate: 4.3, last_activity: new Date().toISOString() },
                    { device_id: "tablet_production", device_name: "Production Tablet", location: "Production Floor", myob_sessions: 18, timeout_risks: 3, actual_timeouts: 2, device_timeout_rate: 11.1, last_activity: new Date().toISOString() },
                    { device_id: "tablet_qc", device_name: "Quality Control Tablet", location: "QC Lab", myob_sessions: 15, timeout_risks: 1, actual_timeouts: 0, device_timeout_rate: 0.0, last_activity: new Date().toISOString() }
                ],
                ai_insights: {
                    pattern_analysis: {
                        time_patterns: {
                            problem_hours: [
                                {hour: 14, timeout_rate: 22.3},
                                {hour: 15, timeout_rate: 18.7}
                            ],
                            recommendation: "Peak timeout risk occurs during lunch hours when users step away"
                        }
                    },
                    predictions: {
                        timeout_trend: {
                            current_rate: 6.8,
                            risk_level: "MEDIUM",
                            prediction: "Timeout incidents manageable but monitor during peak hours",
                            confidence: "HIGH"
                        }
                    },
                    correlations: {
                        battery_myob: {
                            average_battery_during_myob: 72.3,
                            correlation_strength: "WEAK",
                            insight: "MYOB sessions occur at 72.3% average battery"
                        },
                        timeout_factors: {
                            battery_at_timeout: 28.5,
                            wifi_signal_at_timeout: 68.0,
                            primary_factor: "SESSION_LENGTH"
                        }
                    }
                },
                recommendations: [
                    {
                        priority: "HIGH",
                        category: "System Configuration",
                        issue: "Peak timeout hours identified (2-3 PM)",
                        recommendation: "Increase MYOB session timeout during peak hours or implement session extension prompts",
                        expected_impact: "50% reduction in peak-hour timeouts",
                        implementation: "Configure time-based session policies"
                    },
                    {
                        priority: "MEDIUM",
                        category: "User Training",
                        issue: "Users unaware of session timeout risks",
                        recommendation: "Train users on session management and provide timeout warnings",
                        expected_impact: "Improved user awareness and proactive session management",
                        implementation: "User training sessions and in-app notifications"
                    }
                ],
                anomalies: [
                    {
                        type: "PEAK_HOUR_TIMEOUTS",
                        device_id: "multiple_devices",
                        severity: "MEDIUM",
                        recommendation: "Monitor closely during 2-3 PM timeframe"
                    }
                ]
            };
            
            updateBusinessImpact(demoData);
            updateRecommendations(demoData.recommendations);
            updateDeviceMatrix(demoData.device_matrix);
            updateTimeoutPatternChart(demoData.hourly_patterns);
            updateAIInsights(demoData.ai_insights);
            updateAnomalies(demoData.anomalies);
        }
        
        function updateBusinessImpact(analysisData) {
            const businessImpact = analysisData.business_impact || {};
            
            // Update risk indicator
            const riskIndicator = document.getElementById('riskIndicator');
            const riskLevel = businessImpact.risk_level || 'UNKNOWN';
            riskIndicator.textContent = riskLevel;
            riskIndicator.className = `risk-indicator ${riskLevel.toLowerCase()}`;
            
            // Update impact metrics
            document.getElementById('productivityLoss').textContent = businessImpact.productivity_loss_hours || '--';
            document.getElementById('affectedEmployees').textContent = businessImpact.affected_employees || '--';
            document.getElementById('dailyIncidents').textContent = businessImpact.daily_timeout_incidents || '--';
            document.getElementById('efficiencyScore').textContent = (businessImpact.efficiency_score || 0) + '%';
            
            // Calculate and display cost estimates
            const hourlyRate = 25; // Average hourly rate estimate
            const weeklyCost = (businessImpact.productivity_loss_hours || 0) * hourlyRate;
            const annualCost = weeklyCost * 52;
            
            document.getElementById('weeklyCost').textContent = `$${weeklyCost.toFixed(0)}`;
            document.getElementById('annualCost').textContent = `$${annualCost.toFixed(0)}`;
        }
        
        function updateTimeoutPatternChart(hourlyPatterns) {
            const ctx = document.getElementById('timeoutPatternChart').getContext('2d');
            
            if (timeoutPatternChart) {
                timeoutPatternChart.destroy();
            }
            
            const hours = hourlyPatterns.map(p => `${p.hour_of_day}:00`);
            const timeoutRates = hourlyPatterns.map(p => p.hourly_timeout_rate || 0);
            const myobSessions = hourlyPatterns.map(p => p.myob_sessions || 0);
            
            timeoutPatternChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: 'Timeout Rate (%)',
                            data: timeoutRates,
                            borderColor: '#dc2626',
                            backgroundColor: '#dc262620',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'MYOB Sessions',
                            data: myobSessions,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f620',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Timeout Rate (%)' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'MYOB Sessions' },
                            beginAtZero: true,
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });
            
            // Update pattern insights
            const peakHours = hourlyPatterns
                .filter(p => (p.hourly_timeout_rate || 0) > 10)
                .map(p => `${p.hour_of_day}:00`)
                .slice(0, 3);
            
            document.getElementById('peakHours').textContent = 
                peakHours.length > 0 ? peakHours.join(', ') : 'No significant peaks detected';
        }
        
        function updateAIInsights(insights) {
            // Update AI confidence
            const predictions = insights.predictions || {};
            const confidence = predictions.timeout_trend?.confidence || 'UNKNOWN';
            document.getElementById('aiConfidence').textContent = `Confidence: ${confidence}`;
            
            // Pattern Analysis
            const patternAnalysis = insights.pattern_analysis || {};
            const timePatterns = patternAnalysis.time_patterns || {};
            const problemHours = timePatterns.problem_hours || [];
            
            let patternText = '';
            if (problemHours.length > 0) {
                const topHours = problemHours.slice(0, 3);
                patternText = `Identified ${topHours.length} peak problem hours: `;
                patternText += topHours.map(h => `${h.hour}:00 (${h.timeout_rate}% rate)`).join(', ');
                patternText += `. ${timePatterns.recommendation || ''}`;
            } else {
                patternText = 'No significant time-based patterns detected in timeout occurrences.';
            }
            document.getElementById('patternAnalysis').textContent = patternText;
            
            // Predictions
            const timeoutTrend = predictions.timeout_trend || {};
            let predictionText = '';
            if (timeoutTrend.current_rate !== undefined) {
                predictionText = `Current timeout rate: ${timeoutTrend.current_rate}%. `;
                predictionText += `Risk level: ${timeoutTrend.risk_level}. `;
                predictionText += `Prediction: ${timeoutTrend.prediction}`;
            } else {
                predictionText = 'Insufficient data for reliable predictions. Continue monitoring to build prediction models.';
            }
            document.getElementById('predictions').textContent = predictionText;
            
            // Correlations
            const correlations = insights.correlations || {};
            let correlationText = '';
            
            if (correlations.battery_myob) {
                const batteryCorr = correlations.battery_myob;
                correlationText += `Battery correlation: MYOB sessions occur at ${batteryCorr.average_battery_during_myob}% average battery (${batteryCorr.correlation_strength} correlation). `;
            }
            
            if (correlations.timeout_factors) {
                const timeoutFactors = correlations.timeout_factors;
                correlationText += `Timeout factors: Primary factor identified as ${timeoutFactors.primary_factor}. `;
                correlationText += `Average battery at timeout: ${timeoutFactors.battery_at_timeout}%, `;
                correlationText += `WiFi signal: ${timeoutFactors.wifi_signal_at_timeout} dBm.`;
            }
            
            if (!correlationText) {
                correlationText = 'Analyzing correlations between device metrics and timeout occurrences...';
            }
            
            document.getElementById('correlations').textContent = correlationText;
        }
        
        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = `
                    <div class="loading-recommendations">
                        <i class="fas fa-check-circle"></i>
                        <p>No specific recommendations at this time. System is operating within normal parameters.</p>
                    </div>
                `;
                return;
            }
            
            const recommendationsHtml = recommendations.map(rec => `
                <div class="recommendation-item ${rec.priority.toLowerCase()}">
                    <div class="recommendation-header">
                        <div class="recommendation-category">${rec.category}</div>
                        <div class="recommendation-priority ${rec.priority.toLowerCase()}">${rec.priority}</div>
                    </div>
                    <div class="recommendation-text">
                        <strong>Issue:</strong> ${rec.issue}<br>
                        <strong>Recommendation:</strong> ${rec.recommendation}
                    </div>
                    <div class="recommendation-impact">
                        Expected Impact: ${rec.expected_impact}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = recommendationsHtml;
        }
        
        function updateDeviceMatrix(deviceImpact) {
            const tbody = document.getElementById('matrixTableBody');
            
            if (!deviceImpact || deviceImpact.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="loading-cell">No device performance data available</td>
                    </tr>
                `;
                return;
            }
            
            const deviceRows = deviceImpact.map(device => {
                const timeoutRate = device.device_timeout_rate || 0;
                const riskLevel = timeoutRate > 20 ? 'high' : timeoutRate > 10 ? 'medium' : 'low';
                const riskText = timeoutRate > 20 ? 'HIGH' : timeoutRate > 10 ? 'MEDIUM' : 'LOW';
                
                return `
                    <tr>
                        <td>${device.device_name || device.device_id}</td>
                        <td>${device.myob_sessions || 0}</td>
                        <td>${timeoutRate.toFixed(1)}%</td>
                        <td><span class="risk-badge ${riskLevel}">${riskText}</span></td>
                        <td>
                            <button class="action-btn" onclick="viewDeviceDetails('${device.device_id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = deviceRows;
            
            // Update problem devices insight
            const problemDevices = deviceImpact.filter(d => (d.device_timeout_rate || 0) > 15);
            const problemDeviceNames = problemDevices.map(d => d.device_name || d.device_id).slice(0, 3);
            
            document.getElementById('problemDevices').textContent = 
                problemDeviceNames.length > 0 
                    ? problemDeviceNames.join(', ') 
                    : 'No devices showing concerning timeout patterns';
        }
        
        function updateAnomalies(anomalies) {
            const container = document.getElementById('anomalies');
            
            if (!anomalies || anomalies.length === 0) {
                container.innerHTML = `
                    <div class="no-anomalies">
                        <i class="fas fa-check-circle"></i>
                        <span>No critical anomalies detected</span>
                    </div>
                `;
                return;
            }
            
            const anomaliesHtml = anomalies.map(anomaly => `
                <div class="anomaly-item">
                    <div class="anomaly-type">${anomaly.type.replace(/_/g, ' ')}</div>
                    <div class="anomaly-description">
                        Device: ${anomaly.device_id} - ${anomaly.severity} severity
                        ${anomaly.average_battery ? `(Avg Battery: ${anomaly.average_battery}%)` : ''}
                    </div>
                    <div class="anomaly-recommendation">
                        Recommendation: ${anomaly.recommendation}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = anomaliesHtml;
        }
        
        function viewDeviceDetails(deviceId) {
            // Expand the device card if it exists
            toggleDeviceExpand(deviceId);
            
            // Scroll to the device card
            const deviceCard = document.getElementById(`device-${deviceId}`);
            if (deviceCard) {
                deviceCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                deviceCard.style.border = '2px solid #3b82f6';
                setTimeout(() => {
                    deviceCard.style.border = '';
                }, 3000);
            }
        }
        
        function showBIError(message) {
            const riskIndicator = document.getElementById('riskIndicator');
            riskIndicator.textContent = 'ERROR';
            riskIndicator.className = 'risk-indicator critical';
            
            console.error('BI Error:', message);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            loadBusinessIntelligence(); // Load BI data on startup
            
            // Set up auto-refresh for main dashboard (every 60 seconds)
            setInterval(() => {
                if (!userInteracting) {
                    loadDashboard();
                }
            }, 60000);
            
            // Set up auto-refresh for business intelligence (every 5 minutes)
            setInterval(() => {
                if (!userInteracting) {
                    loadBusinessIntelligence();
                }
            }, 300000);
        });
    </script>
</body>
</html> 