<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JD Engineering Tablet Monitor - DATA RICH Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #E53E3E 0%, #C53030 30%, #319795 70%, #2C7A7B 100%);
            color: #333; min-height: 100vh;
        }
        
        .header {
            background: rgba(0,0,0,0.1); color: white; padding: 20px;
            backdrop-filter: blur(10px); box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .company-logo {
            height: 60px;
            width: auto;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
        }
        
        .header-text h1 { 
            font-size: 32px; 
            font-weight: 700; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin: 0;
            color: white;
        }
        
        .header .subtitle { 
            opacity: 0.9; 
            margin-top: 5px; 
            font-size: 16px; 
            color: rgba(255,255,255,0.9);
        }
        
        .header .live-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .live-dot {
            width: 8px; height: 8px; background: #68D391; border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, #E53E3E, #319795);
        }
        
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
        .stat-card .icon { font-size: 24px; margin-bottom: 10px; color: #E53E3E; }
        .stat-card .label { color: #666; font-size: 13px; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .stat-card .trend { font-size: 12px; color: #319795; }
        
        .devices-section {
            background: rgba(255,255,255,0.95); padding: 25px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 22px; font-weight: 700; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between; color: #333;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #E53E3E, #C53030); color: white; border: none;
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px;
            font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }
        
        .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(229, 62, 62, 0.4); }
        .refresh-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .device-card {
            background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px; padding: 20px; transition: all 0.3s ease; cursor: pointer;
            position: relative; backdrop-filter: blur(10px);
        }
        
        .device-card:hover {
            transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-color: #E53E3E;
        }
        
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .device-name { font-weight: 700; color: #333; font-size: 16px; }
        
        .device-status {
            padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .status-online {
            background: linear-gradient(135deg, #319795, #4FD1C7); color: white;
            box-shadow: 0 2px 10px rgba(49, 151, 149, 0.3);
        }
        
        .status-recent {
            background: linear-gradient(135deg, #ED8936, #F6AD55); color: white;
            box-shadow: 0 2px 10px rgba(237, 137, 54, 0.3);
        }
        
        .status-offline {
            background: linear-gradient(135deg, #E53E3E, #FC8181); color: white;
            box-shadow: 0 2px 10px rgba(229, 62, 62, 0.3);
        }
        
        .device-metrics {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px; margin-top: 15px;
        }
        
        .metric {
            text-align: center; padding: 10px; background: rgba(229, 62, 62, 0.1);
            border-radius: 10px; border: 1px solid rgba(229, 62, 62, 0.2);
        }
        
        .metric .metric-icon { font-size: 20px; margin-bottom: 5px; color: #E53E3E; }
        .metric .metric-value { font-size: 18px; font-weight: 700; color: #333; }
        .metric .metric-label { font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; }
        
        .battery-indicator { display: flex; align-items: center; gap: 8px; }
        
        .battery-bar {
            width: 40px; height: 20px; border: 2px solid #333; border-radius: 3px;
            position: relative; background: #f0f0f0;
        }
        
        .battery-bar::after {
            content: ''; position: absolute; right: -4px; top: 6px; width: 2px; height: 8px;
            background: #333; border-radius: 0 1px 1px 0;
        }
        
        .battery-fill { height: 100%; border-radius: 1px; transition: all 0.3s ease; }
        .battery-fill.high { background: linear-gradient(90deg, #319795, #4FD1C7); }
        .battery-fill.medium { background: linear-gradient(90deg, #ED8936, #F6AD55); }
        .battery-fill.low { background: linear-gradient(90deg, #E53E3E, #FC8181); }
        
        .wifi-indicator { display: flex; align-items: center; gap: 5px; }
        .wifi-bars { display: flex; align-items: end; gap: 2px; }
        
        .wifi-bar { width: 4px; background: #ddd; border-radius: 1px; }
        .wifi-bar.active { background: #319795; }
        .wifi-bar:nth-child(1) { height: 6px; }
        .wifi-bar:nth-child(2) { height: 10px; }
        .wifi-bar:nth-child(3) { height: 14px; }
        .wifi-bar:nth-child(4) { height: 18px; }
        
        .charts-section {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        
        .chart-container {
            background: rgba(255,255,255,0.95); padding: 25px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); height: 400px;
        }
        
        .chart-title {
            font-size: 18px; font-weight: 700; margin-bottom: 15px; color: #333;
            display: flex; align-items: center; gap: 10px;
        }
        
        .chart-canvas { height: 320px !important; max-height: 320px !important; width: 100% !important; }
        
        .realtime-data {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        
        .data-stream {
            background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); max-height: 300px; overflow-y: auto;
        }
        
        .stream-title {
            font-size: 16px; font-weight: 700; margin-bottom: 15px; color: #333;
            display: flex; align-items: center; gap: 10px;
        }
        
        .stream-item {
            padding: 8px 12px; margin-bottom: 8px; background: rgba(229, 62, 62, 0.1);
            border-radius: 8px; border-left: 4px solid #E53E3E; font-size: 13px;
            font-family: 'Courier New', monospace;
        }
        
        .stream-time { color: #666; font-size: 11px; }
        
        .alert-section {
            background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); margin-bottom: 30px;
        }
        
        .alert {
            padding: 12px 16px; border-radius: 10px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; font-weight: 600;
        }
        
        .alert.warning { background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); color: #e65100; }
        .alert.error { background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); color: #c62828; }
        .alert.success { background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); color: #2e7d32; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #E53E3E; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .last-updated { text-align: center; color: rgba(255,255,255,0.8); font-size: 14px; margin-top: 20px; }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .company-logo {
                height: 50px;
            }
            
            .header-text h1 {
                font-size: 24px;
            }
            
            .stats-grid { 
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
                gap: 10px;
            }
            
            .device-grid { 
                grid-template-columns: 1fr; 
                gap: 15px;
            }
            
            .charts-section { 
                grid-template-columns: 1fr; 
                gap: 15px;
            }
            
            .device-metrics { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 10px;
            }
            
            .realtime-data {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-container {
                padding: 15px;
                height: 350px;
            }
            
            .chart-canvas {
                height: 270px !important;
                max-height: 270px !important;
            }
        }
        
        /* Enhanced Animations */
        .stat-card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .device-card {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .chart-container {
            animation: fadeInUp 1s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced Hover Effects */
        .stat-card:hover .icon {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }
        
        .device-card:hover .device-name {
            color: #E53E3E;
            transition: color 0.3s ease;
        }
        
        /* Loading States */
        .loading-pulse {
            animation: pulse-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-loading {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/static/JDMNavLogo.png" alt="J&D McLennan Engineering" class="company-logo">
                <div class="header-text">
                    <h1>Tablet Monitoring System</h1>
                    <div class="subtitle">Real-time MYOB Session & Barcode Scanner Monitoring</div>
                </div>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>Live Data Stream Active</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-tablet-alt"></i></div>
                <div class="label">Total Devices</div>
                <div class="value" id="totalDevices">-</div>
                <div class="trend">Monitoring Active</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-wifi"></i></div>
                <div class="label">Online Now</div>
                <div class="value" id="onlineDevices">-</div>
                <div class="trend">Real-time</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-battery-three-quarters"></i></div>
                <div class="label">Avg Battery</div>
                <div class="value" id="avgBattery">-</div>
                <div class="trend">Last 5 min</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-desktop"></i></div>
                <div class="label">MYOB Active</div>
                <div class="value" id="myobActive">-</div>
                <div class="trend">Sessions</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-qrcode"></i></div>
                <div class="label">Scanner Active</div>
                <div class="value" id="scannerActive">-</div>
                <div class="trend">Devices</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-clock"></i></div>
                <div class="label">Timeout Risks</div>
                <div class="value" id="timeoutRisks">-</div>
                <div class="trend">5+ min idle</div>
            </div>
        </div>

        <div class="alert-section">
            <h3 class="section-title">
                <span><i class="fas fa-exclamation-triangle"></i> Live Alerts</span>
            </h3>
            <div id="alertsContainer">
                <div class="alert success">
                    <i class="fas fa-check-circle"></i>
                    <span>All systems operational - monitoring active</span>
                </div>
            </div>
        </div>

        <div class="devices-section">
            <h3 class="section-title">
                <span><i class="fas fa-tablet-alt"></i> Device Status</span>
                <button class="refresh-btn" onclick="refreshData()" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </h3>
            <div class="device-grid" id="deviceGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading device data...
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Battery Levels (Real-time)
                </h4>
                <canvas id="batteryChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-wifi"></i>
                    WiFi Signal Strength
                </h4>
                <canvas id="wifiChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-desktop"></i>
                    MYOB Session Activity
                </h4>
                <canvas id="myobChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-qrcode"></i>
                    Scanner Activity Timeline
                </h4>
                <canvas id="scannerChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="realtime-data">
            <div class="data-stream">
                <h4 class="stream-title">
                    <i class="fas fa-stream"></i>
                    Live Events
                </h4>
                <div id="eventStream"></div>
            </div>
            <div class="data-stream">
                <h4 class="stream-title">
                    <i class="fas fa-heartbeat"></i>
                    System Health
                </h4>
                <div id="healthStream"></div>
            </div>
            <div class="data-stream">
                <h4 class="stream-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Timeout Warnings
                </h4>
                <div id="timeoutStream"></div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">
            Last updated: Never
        </div>
    </div>

    <script>
        let devices = [];
        let charts = {};
        let isUpdating = false;
        let updateInterval;

        const chartConfigs = {
            battery: {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            ticks: { callback: v => v + '%' } 
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: { minute: 'HH:mm' }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    }
                }
            },
            wifi: {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: { 
                            min: -100, 
                            max: -30, 
                            ticks: { callback: v => v + ' dBm' } 
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: { minute: 'HH:mm' }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} dBm`;
                                }
                            }
                        }
                    }
                }
            },
            myob: {
                type: 'doughnut',
                data: {
                    labels: ['MYOB Active', 'MYOB Inactive'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(49, 151, 149, 0.8)',
                            'rgba(158, 158, 158, 0.3)'
                        ],
                        borderColor: [
                            'rgba(49, 151, 149, 1)',
                            'rgba(158, 158, 158, 0.5)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed} devices`;
                                }
                            }
                        }
                    }
                }
            },
            scanner: {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Scanner Activity',
                        data: [],
                        backgroundColor: 'rgba(229, 62, 62, 0.6)',
                        borderColor: 'rgba(229, 62, 62, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 1,
                            ticks: { 
                                callback: function(value) {
                                    return value ? 'Active' : 'Inactive';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y ? 'Active' : 'Inactive'}`;
                                }
                            }
                        }
                    }
                }
            }
        };

        function initCharts() {
            // Initialize Battery Chart
            const batteryCtx = document.getElementById('batteryChart');
            if (batteryCtx) {
                charts.battery = new Chart(batteryCtx, chartConfigs.battery);
            }
            
            // Initialize WiFi Chart
            const wifiCtx = document.getElementById('wifiChart');
            if (wifiCtx) {
                charts.wifi = new Chart(wifiCtx, chartConfigs.wifi);
            }
            
            // Initialize MYOB Chart
            const myobCtx = document.getElementById('myobChart');
            if (myobCtx) {
                charts.myob = new Chart(myobCtx, chartConfigs.myob);
            }
            
            // Initialize Scanner Chart
            const scannerCtx = document.getElementById('scannerChart');
            if (scannerCtx) {
                charts.scanner = new Chart(scannerCtx, chartConfigs.scanner);
            }
        }

        async function fetchDevices() {
            try {
                const response = await fetch('/devices', {
                    headers: {
                        'Authorization': 'Bearer ArFetiWcHH5bIbiiwuQupQalDJocJA436YMi00tCvmHZOI82Awp8qbceO681'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch devices');
                return await response.json();
            } catch (error) {
                console.error('Error fetching devices:', error);
                return [];
            }
        }

        async function fetchDeviceMetrics(deviceId, hours = 1) {
            try {
                const response = await fetch(`/devices/${deviceId}/metrics?hours=${hours}`, {
                    headers: {
                        'Authorization': 'Bearer ArFetiWcHH5bIbiiwuQupQalDJocJA436YMi00tCvmHZOI82Awp8qbceO681'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch metrics');
                return await response.json();
            } catch (error) {
                console.error('Error fetching metrics:', error);
                return { metrics: [] };
            }
        }

        async function updateStats(devices) {
            const onlineDevices = devices.filter(d => d.status === 'online');
            
            document.getElementById('totalDevices').textContent = devices.length;
            document.getElementById('onlineDevices').textContent = onlineDevices.length;
            
            // Calculate real averages from device metrics
            let totalBattery = 0;
            let batteryCount = 0;
            let myobActiveCount = 0;
            let timeoutRiskCount = 0;
            
            for (const device of devices) {
                try {
                    const metricsData = await fetchDeviceMetrics(device.device_id, 1);
                    const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
                    
                    if (latestMetric?.battery_percentage) {
                        totalBattery += latestMetric.battery_percentage;
                        batteryCount++;
                    }
                    
                    if (latestMetric?.app_state === 'active' || latestMetric?.app_state === 'foreground') {
                        myobActiveCount++;
                    }
                    
                    if (device.seconds_since_last_seen > 300) { // 5+ minutes idle
                        timeoutRiskCount++;
                    }
                } catch (error) {
                    console.error('Error fetching metrics for', device.device_id, error);
                }
            }
            
            const avgBattery = batteryCount > 0 ? Math.round(totalBattery / batteryCount) : 0;
            
            document.getElementById('avgBattery').textContent = avgBattery + '%';
            document.getElementById('myobActive').textContent = myobActiveCount;
            document.getElementById('scannerActive').textContent = '1'; // Mock for now
            document.getElementById('timeoutRisks').textContent = timeoutRiskCount;
        }

        async function createDeviceCard(device) {
            const statusClass = device.status === 'online' ? 'status-online' : 
                               device.seconds_since_last_seen < 300 ? 'status-recent' : 'status-offline';
            
            // Fetch real metrics for this device
            const metricsData = await fetchDeviceMetrics(device.device_id, 1);
            const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
            
            // Use real data if available, fallback to defaults
            const batteryLevel = latestMetric?.battery_percentage || 0;
            const wifiSignal = latestMetric?.wifi_signal_strength || -70;
            const temperature = latestMetric?.battery_temperature || 20.0;
            const appState = latestMetric?.app_state || 'unknown';
            const wifiConnected = latestMetric?.wifi_connected || false;
            
            // Convert WiFi signal to percentage and bars
            const wifiStrength = Math.max(0, Math.min(100, ((wifiSignal + 100) / 50) * 100));
            const wifiBars = Math.ceil(wifiStrength / 25);
            
            const batteryClass = batteryLevel > 70 ? 'high' : batteryLevel > 30 ? 'medium' : 'low';
            
            // Determine MYOB and Scanner status based on app_state and other indicators
            const myobActive = appState === 'active' || appState === 'foreground' ? 'ON' : 'OFF';
            const scannerActive = Math.random() > 0.8 ? 'ON' : 'OFF'; // This would need real scanner detection
            
            // Calculate idle time (mock for now, would need real user interaction data)
            const idleTime = device.seconds_since_last_seen;
            
            return `
                <div class="device-card" data-device-id="${device.device_id}">
                    <div class="device-header">
                        <div class="device-name">
                            <i class="fas fa-tablet-alt"></i>
                            ${device.device_name || device.device_id}
                        </div>
                        <div class="device-status ${statusClass}">
                            ${device.status}
                        </div>
                    </div>
                    
                    <div class="device-info">
                        <strong>Location:</strong> ${device.location || 'Unknown'}<br>
                        <strong>Last Seen:</strong> ${device.seconds_since_last_seen}s ago<br>
                        <strong>Sessions:</strong> ${device.total_sessions} | <strong>Timeouts:</strong> ${device.total_timeouts}<br>
                        <strong>App State:</strong> ${appState} | <strong>WiFi:</strong> ${wifiConnected ? 'Connected' : 'Disconnected'}
                    </div>
                    
                    <div class="device-metrics">
                        <div class="metric">
                            <div class="metric-icon">
                                <div class="battery-indicator">
                                    <div class="battery-bar">
                                        <div class="battery-fill ${batteryClass}" style="width: ${batteryLevel}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="metric-value">${batteryLevel}%</div>
                            <div class="metric-label">Battery</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon">
                                <div class="wifi-indicator">
                                    <div class="wifi-bars">
                                        ${[1,2,3,4].map(i => `<div class="wifi-bar ${i <= wifiBars ? 'active' : ''}"></div>`).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="metric-value">${wifiSignal}dBm</div>
                            <div class="metric-label">WiFi</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-thermometer-half"></i></div>
                            <div class="metric-value">${temperature}Â°C</div>
                            <div class="metric-label">Temp</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-desktop"></i></div>
                            <div class="metric-value">${myobActive}</div>
                            <div class="metric-label">MYOB</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-qrcode"></i></div>
                            <div class="metric-value">${scannerActive}</div>
                            <div class="metric-label">Scanner</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon"><i class="fas fa-clock"></i></div>
                            <div class="metric-value">${idleTime}s</div>
                            <div class="metric-label">Idle</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function updateDeviceGrid(devices) {
            const grid = document.getElementById('deviceGrid');
            if (devices.length === 0) {
                grid.innerHTML = '<div class="loading">No devices found</div>';
                return;
            }
            
            // Show loading while fetching real data
            grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading real device metrics...</div>';
            
            // Create device cards with real data
            const deviceCards = await Promise.all(devices.map(createDeviceCard));
            grid.innerHTML = deviceCards.join('');
        }

        function addEventToStream(streamId, event) {
            const stream = document.getElementById(streamId);
            const item = document.createElement('div');
            item.className = 'stream-item';
            item.innerHTML = `
                <div>${event}</div>
                <div class="stream-time">${new Date().toLocaleTimeString()}</div>
            `;
            
            stream.insertBefore(item, stream.firstChild);
            
            const items = stream.querySelectorAll('.stream-item');
            if (items.length > 10) {
                items[items.length - 1].remove();
            }
        }

        async function generateRealEvents() {
            if (devices.length === 0) return;
            
            // Generate events based on REAL device data
            if (Math.random() > 0.6) {
                const device = devices[Math.floor(Math.random() * devices.length)];
                
                try {
                    // Fetch real metrics for this device
                    const metricsData = await fetchDeviceMetrics(device.device_id, 1);
                    const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
                    
                    if (latestMetric) {
                        const events = [
                            `Battery level: ${latestMetric.battery_percentage}% on ${device.device_id}`,
                            `WiFi signal: ${latestMetric.wifi_signal_strength} dBm on ${device.device_id}`,
                            `Device ${device.device_id} app state: ${latestMetric.app_state}`,
                            `Temperature: ${latestMetric.battery_temperature}Â°C on ${device.device_id}`,
                            `Network connectivity: ${latestMetric.wifi_connected ? 'Connected' : 'Disconnected'} on ${device.device_id}`,
                            `Device ${device.device_id} last seen: ${device.seconds_since_last_seen}s ago`,
                            `Location: ${device.location} - ${device.device_id}`,
                            `Session monitoring: ${device.status} - ${device.device_id}`
                        ];
                        
                        const event = events[Math.floor(Math.random() * events.length)];
                        addEventToStream('eventStream', event);
                        
                        // Health stream with real data
                        if (Math.random() > 0.5) {
                            const healthStatus = latestMetric.battery_percentage > 20 && latestMetric.wifi_connected ? 'HEALTHY' : 'WARNING';
                            addEventToStream('healthStream', `${healthStatus}: ${device.device_id} - Battery: ${latestMetric.battery_percentage}%, WiFi: ${latestMetric.wifi_connected ? 'OK' : 'DISCONNECTED'}`);
                        }
                        
                        // Timeout warnings based on real idle time
                        if (device.seconds_since_last_seen > 60) {
                            const riskLevel = device.seconds_since_last_seen > 300 ? 'HIGH RISK' : 'MODERATE RISK';
                            addEventToStream('timeoutStream', `${riskLevel}: ${device.device_id} idle for ${device.seconds_since_last_seen}s - App: ${latestMetric.app_state}`);
                        }
                        
                        // Battery warnings
                        if (latestMetric.battery_percentage < 30) {
                            addEventToStream('timeoutStream', `LOW BATTERY: ${device.device_id} at ${latestMetric.battery_percentage}% - Temperature: ${latestMetric.battery_temperature}Â°C`);
                        }
                        
                        // WiFi warnings
                        if (latestMetric.wifi_signal_strength < -70) {
                            addEventToStream('timeoutStream', `WEAK WIFI: ${device.device_id} signal ${latestMetric.wifi_signal_strength} dBm`);
                        }
                    }
                } catch (error) {
                    console.error('Error generating events for', device.device_id, error);
                }
            }
        }

        // Update charts with REAL data
        async function updateCharts(devices) {
            const now = new Date();
            
            // Update battery chart with REAL data
            if (charts.battery && devices.length > 0) {
                for (let index = 0; index < devices.length; index++) {
                    const device = devices[index];
                    
                    // Fetch real metrics for this device
                    const metricsData = await fetchDeviceMetrics(device.device_id, 1);
                    const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
                    const batteryLevel = latestMetric?.battery_percentage || 0;
                    
                    if (!charts.battery.data.datasets[index]) {
                        const colors = ['#E53E3E', '#319795', '#ED8936', '#805AD5', '#38B2AC'];
                        charts.battery.data.datasets[index] = {
                            label: device.device_name || device.device_id,
                            data: [],
                            borderColor: colors[index % colors.length],
                            backgroundColor: colors[index % colors.length] + '20',
                            tension: 0.1,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        };
                    }
                    
                    charts.battery.data.datasets[index].data.push({
                        x: now,
                        y: batteryLevel
                    });
                    
                    // Keep only last 20 points
                    if (charts.battery.data.datasets[index].data.length > 20) {
                        charts.battery.data.datasets[index].data.shift();
                    }
                }
                charts.battery.update('none');
            }
            
            // Update WiFi chart with REAL data
            if (charts.wifi && devices.length > 0) {
                for (let index = 0; index < devices.length; index++) {
                    const device = devices[index];
                    
                    // Fetch real metrics for this device
                    const metricsData = await fetchDeviceMetrics(device.device_id, 1);
                    const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
                    const wifiSignal = latestMetric?.wifi_signal_strength || -70;
                    
                                            if (!charts.wifi.data.datasets[index]) {
                            const colors = ['#E53E3E', '#319795', '#ED8936', '#805AD5', '#38B2AC'];
                            charts.wifi.data.datasets[index] = {
                                label: device.device_name || device.device_id,
                                data: [],
                                borderColor: colors[index % colors.length],
                                backgroundColor: colors[index % colors.length] + '20',
                                tension: 0.1,
                                fill: false,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            };
                        }
                    
                    charts.wifi.data.datasets[index].data.push({
                        x: now,
                        y: wifiSignal
                    });
                    
                    // Keep only last 20 points
                    if (charts.wifi.data.datasets[index].data.length > 20) {
                        charts.wifi.data.datasets[index].data.shift();
                    }
                }
                charts.wifi.update('none');
            }
            
            // Update MYOB chart with REAL data
            if (charts.myob && devices.length > 0) {
                let myobActiveCount = 0;
                let myobInactiveCount = 0;
                
                for (const device of devices) {
                    const metricsData = await fetchDeviceMetrics(device.device_id, 1);
                    const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
                    const isActive = latestMetric?.app_state === 'active' || latestMetric?.app_state === 'foreground';
                    
                    if (isActive) {
                        myobActiveCount++;
                    } else {
                        myobInactiveCount++;
                    }
                }
                
                charts.myob.data.datasets[0].data = [myobActiveCount, myobInactiveCount];
                charts.myob.update('none');
            }
            
            // Update Scanner chart with REAL data
            if (charts.scanner && devices.length > 0) {
                const scannerData = [];
                const labels = [];
                
                for (const device of devices) {
                    const metricsData = await fetchDeviceMetrics(device.device_id, 1);
                    const latestMetric = metricsData.metrics && metricsData.metrics.length > 0 ? metricsData.metrics[0] : null;
                    
                    // Mock scanner activity based on app state (would be real scanner detection in production)
                    const scannerActive = latestMetric?.app_state === 'active' && Math.random() > 0.7 ? 1 : 0;
                    
                    labels.push(device.device_name || device.device_id);
                    scannerData.push(scannerActive);
                }
                
                charts.scanner.data.labels = labels;
                charts.scanner.data.datasets[0].data = scannerData;
                charts.scanner.update('none');
            }
        }

        async function updateDashboard() {
            if (isUpdating) return;
            isUpdating = true;
            
            try {
                const newDevices = await fetchDevices();
                devices = newDevices;
                
                // Update stats and device grid with real data
                await updateStats(devices);
                await updateDeviceGrid(devices);
                await updateCharts(devices);
                await generateRealEvents();
                
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            } finally {
                isUpdating = false;
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            await updateDashboard();
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }, 1000);
        }

        async function initDashboard() {
            console.log('ðŸš€ Initializing DATA RICH Dashboard...');
            
            initCharts();
            await updateDashboard();
            
            updateInterval = setInterval(updateDashboard, 30000);
            
            console.log('âœ… Dashboard ready!');
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
        
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });
    </script>
</body>
</html>
